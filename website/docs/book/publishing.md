---
id: publishing
title: Публикация пакетов
---

Pvm имеет свою команду для публикации пакетов `yarn pvm publish`, хотя вы можете публиковать пакеты с помощью других инструментов.
Здесь опишем как работает именно `pvm publish`:

1. Вычисляет список пакетов на публикацию
1. Опционально задает [порядок публикации](#publishing-order)
1. Выполняет публикацию пакетов вызывая для каждого `npm publish` с заданной конкурентностью
1. Оповещает о публикации пакетов в слак

Команда завершается с кодом выхода `1` если хоть один пакет не удалось успешно опубликовать.

## Этапы публикации

### Список пакетов

По умолчанию публикуются только те пакеты, которые поменяли свою версию в последнем релизе.
Изменить это можно с помощью опции `-s`:

| Значение опции `-s` | Публикуемые пакеты |
| -- | -- |
| `released` (по умолчанию) | пакеты, которые поменяли свою версию в последнем релизе |
| `all` | все пакеты |
| `stale` | пакеты, версия которых меньше чем в заданном реестре |

<div id="publishing-order" className="customAnchor anchor"/>

### Порядок публикации

По умолчанию пакеты публикуются в произвольном порядке.
Однако если у вас настроены prepublish скрипты, и вам важен порядок в котором происходит публикация сначала независимых пакетов, и только затем зависимых от них,
то порядок можно изменить с помощью опции `--by-dependent-order`.

В этом случае будет построено дерево из пакетов, исходя из зависимостей между ними. Первыми будут опубликованы пакеты без зависимостей (листья дерева), затем оставшиеся листья, и так далее.
Правда есть ограничение: данный вид публикации не будет работать если у вас есть циклические зависимости между пакетами.

### Непосредственно публикация

pvm публикует пакеты с помощью вызова команды `npm publish`. 
Конкурентность вызова задается параметром [--concurrency](#concurrency).

### Оповещение о релизе в слак

После публикации pvm будет по умолчанию отправляет нотификацию в слак о пакетах, которые были опубликованы.
Отключить это поведение можно с помощью опции `--no-notify`.

Для отправки нотификации будут использованы переменные `SLACK_TOKEN`, `SLACK_WEBHOOK_URL` или `PVM_SLACK_TOKEN`, `PVM_SLACK_WEBHOOK_URL`.
В приоритете используется вебхук переменные, однако они не рекомендуются и лучше настроить токен. 
Если переменные не заданы, сформированное сообщение для отправки в слак будет просто выведено в stdout.

Настройки отправки:

* `slack_notification.channel` – в какой канал отправлять сообщение, например `#wwdc`.
* `slack_notification.icon_emoji` – текстовое представление emoji-иконки сообщения в слаке, например `:apple:`.
* `slack_notification.<something>` – любые другие настройки пойдет как есть в тело запроса на отправку сообщения в слак.

## Формирование сообщения

Сообщение, которое будет отправлено в слак можно переопределять через параметр `--notify-script` и принимать этот параметр может либо специальный скрипт,
который вы напишите сами, либо имя предустановленного скрипта.

Какие есть предустановленные скрипты:

### release

```bash
yarn -s pvm publish --notify-script release
```

Это значение по умолчанию.

Выводит ченжлог на основе коммитов между релизами, примерно в следующем виде:

import { Release } from '@site/src/components/slack-release'

<Release
  appTitle="WWDC"
  releaseTitle="Big-Sur"
  lines={[['AAPL-2020', 'Исправлено мерцание экрана при смене настроек вывода изображения']]}
/>

Где,

* `WWDC` берется из настройки `slack_notification.username`
* `Big-Sur` это [имя релиза](updating/updating-process.md#release-tag), будет ссылкой если в настройках задан урл `templating.vars.releaseLink`.
* `AAPL-2020` это просто часть коммит-месседжа, но если задана настройка `jira.url`, то весь текст в формате UPPERCASE-XYZ будет преобразовываться в ссылки на задачи в jira.

### release-with-packages

```bash
yarn -s pvm publish --notify-script release-with-packages
```

Формат сообщения такой-же как и предыдущий, но добавляется список опубликованных пакетов:

import { ReleaseWithPackages } from '@site/src/components/slack-release'

<ReleaseWithPackages
  appTitle="WWDC"
  releaseTitle="Big-Sur"
  lines={[['AAPL-2020', 'Исправлено мерцание экрана при смене настроек вывода изображения']]}
  packages={['@aapl/osx@2020', '@aapl/m1@2020']}
/>


### Свой скрипт

Вы можете использовать свой скрипт для формирования сообщения в слак.
В этом случае вы можете передать абсолютный путь до файла, или путь относительный к проекту, или http/https URL до скрипта, расположенный в сети.

Скрипт обязан отправить сообщение с помощью функции `process.send`.
Сообщение должно быть в следующем формате:

```json5
{ type: 'message', message: <message payload for slack> }
```

Также скрипт получает информацию о релизе в сообщении в следующем формате:

```typescript
export interface Commit {
  commit: RefRecord,
  tree: RefRecord,
  author: Committer,
  committer: Committer,
  subject: string,
  body: string,
}

export interface PkgSuccessStats {
  pkg: string,
  registryVersion: string | null,
  publishedVersion: string,
}

export interface PkgFailStats {
  pkg: string,
  publishVersion: string,
  reason: string,
}

export interface PublishedStats {
  success: PkgSuccessStats[],
  skipped: PkgFailStats[],
  error: PkgFailStats[],
}

export interface ReleasedProps {
  tag: string,
  targetType: 'slack',
  commits: Commit[] | undefined,
  packagesStats: PublishedStats,
  pvmConfig: Config,
  registry?: string | undefined,
}
```

где `ReleasedProps` это формат отправляемого сообщения.

Пример, как его можно обработать:

```javascript
process.on('message', releasedProps => {
  const message = calcReleaseMessage(releaseProps)

  process.send({
    type: 'message',
    message,
  })
})
```

## Остальные опции

### registry

Откуда будет взят registry для публикации в порядке убывания приоритета:

- package.json/publishConfig.registry конкретного пакета
- опция `--registry` или `-r` переданная в команду `pvm publish`
- из pvm-конфига `publish.registry`

### concurrency

Параметр задает сколько команд `npm publish` запускать одновременно.
Если указать без значения, будет использовано количество логических процессоров в системе.

### bail

Падать сразу при первой ошибке. Без этого параметра pvm будет публиковать все пакеты, даже если какой-то не удалось опубликовать.

### tag

Смысл опции точно такой же как и команды `npm publish`: задает тег при публикации.
По умолчанию равен `latest`, однако если для конкретного пакета в реестре под тегом `latest` опубликована версия старше чем мы пытаемся опубликовать,
то в данном случае будет использован либо суффикс версии: например, если версия пакета 1.0.0-review, то тег будет взят `review`. 
Либо если суффикса нет, будет использована константа `pvm-last-published`.

### dry-run

Добавляет опцию `--dry-run` во все подвызовы `npm publish`. Таким образом реальной публикации сделано не будет.

### canary

Включает режим публикации canary релиза. Что это значит:
1. Публикация может выполняться без предыдущего релизного коммита/тега командой
2. Стратегией получения списка пакетов для публикации по-умолчанию становится `affected`
3. Не создается релиз и не генерируется чейнджлог
4. Не отправляются нотификации в слак
5. Тегом для npm версии по-умолчанию становтися sha-коммита, из которого делается релиз
6. Меняется логика расчета версии пакета на следующую.

| Существующая версия | Canary - версия |
   |---------------------|-----------------|
   |1.0.0@latest|1.0.0-sha.0@sha|
   |1.0.0-beta.0@latest|1.0.0-sha.0@sha|
   |1.0.0-sha.0@sha|1.0.0-sha.1@sha|
   |1.0.0-sha.0@beta|1.0.0-sha.1@sha|
   |1.0.0-beta.0@sha|1.0.0-sha.0@sha|
